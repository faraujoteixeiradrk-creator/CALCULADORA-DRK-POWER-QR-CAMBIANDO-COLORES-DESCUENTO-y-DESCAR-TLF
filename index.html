<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">DRK: Comparador de Tarifas 2.0 TD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        drk: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        // NUEVOS COLORES: POWER CUP (Verde y Amarillo)
                        powercup: {
                            50: '#f7fee7',
                            100: '#ecfccb',
                            500: '#84cc16', // Verde principal
                            600: '#65a30d',
                            800: '#3f6212', // Verde oscuro
                            900: '#365314',
                            'yellow-flash': '#facc15', // Rayo amarillo
                        },
                        'cta-red': {
                            500: '#CC0000',
                            600: '#A00000',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilo base */
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Estilos de escáner */
        #interactive.viewport { position: relative; width: 100%; height: auto; overflow: hidden; border-radius: 1rem; }
        #interactive.viewport > video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Loading */
        .loading-ring { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid var(--primary-500); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Animación de entrada */
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Estilos específicos para los selectores de modo */
        .mode-selector {
            border: 2px solid;
            /* Usará color dinámico en JS */
        }

        /* Estilos para la sección desplegable del QR */
        #qr-content-wrapper {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
        }

        #qr-content-wrapper.active {
            max-height: 500px; /* Suficiente para contener el QR */
            opacity: 1;
        }

        /* Estilos para el contenedor del QR que imita el diseño con logo */
        #qr-visual-container {
            position: relative;
            display: inline-block;
            background-color: white;
            border-radius: 1rem;
            padding: 1rem;
            /* Usar CSS variables para el color del borde */
            border: 4px solid var(--qr-border-color, #0ea5e9); 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #qr-visual-container::before {
            /* Usar CSS variables para el texto y el fondo del centro */
            content: var(--qr-center-text, "DRK");
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
            background-color: var(--qr-center-bg, #0c4a6e); 
            padding: 8px 12px;
            border-radius: 6px;
            z-index: 10;
            opacity: 0.9;
        }

    </style>
    <!-- CDN para generar el código QR de instalación (qrcode.js) -->
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body class="flex flex-col min-h-screen text-slate-800">

    <!-- Navbar (Ajustado para usar clases dinámicas) -->
    <div id="navbar" class="w-full bg-drk-900 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-tight" id="app-logo-text">DRK <span class="text-drk-500" id="app-logo-accent">Energía</span></h1>
            <span class="text-xs bg-drk-800 px-2 py-1 rounded text-drk-100" id="app-subtitle">Comparador Pro 2.0TD</span>
        </div>
    </div>

    <div id="app" class="w-full max-w-lg mx-auto p-4 md:p-6 flex-grow">
        
        <!-- Vista Inicial (Ajustado para usar clases dinámicas) -->
        <div id="initial-view" class="fade-in">
            <div id="initial-card" class="bg-white p-6 rounded-3xl shadow-xl text-center border-t-4 border-drk-500 relative">
                <div id="tariff-badge" class="absolute top-4 right-4 bg-drk-500 px-2 py-1 rounded-full text-white text-xs font-bold shadow-md">
                    V - <span id="tariff-display-badge">0</span>
                </div>
                <!-- START: NEW COMPARISON MODE SELECTORS -->
                <div id="mode-selector-container" class="mb-4 bg-drk-50 p-3 rounded-xl border border-drk-100">
                    <p class="text-sm font-bold text-drk-800 mb-2">MODO DE COMPARACIÓN</p>
                    <div id="comparison-mode-selectors" class="flex flex-wrap justify-center gap-2 text-sm">
                        <!-- Selector 1: DRK Únicamente -->
                        <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2 text-slate-600 bg-white hover:bg-drk-100" 
                                id="mode-drk-only-label">
                            <input type="radio" name="comparison_mode" value="drk_only" id="mode-drk-only" class="hidden">
                            <!-- NUEVA ESTRUCTURA PARA ICONO -->
                            <span class="font-semibold flex items-center justify-between w-full">
                                DRK Únicamente
                                <svg class="w-4 h-4 ml-1 checkmark-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="visibility: hidden;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </span>
                        </label>
                        <!-- Selector 2: DRK Prioritario (Default) -->
                        <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2 border-drk-500 text-white bg-drk-500 hover:bg-drk-600" 
                                id="mode-drk-prioritized-label">
                            <input type="radio" name="comparison_mode" value="drk_prioritized" id="mode-drk-prioritized" class="hidden" checked>
                            <!-- NUEVA ESTRUCTURA PARA ICONO -->
                            <span class="font-semibold flex items-center justify-between w-full">
                                DRK Prioritario
                                <svg class="w-4 h-4 ml-1 checkmark-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </span>
                        </label>
                        <!-- Selector 3: Mejor en el Mercado -> CAMBIADO A POWER CUP GLOBAL -->
                        <label class="mode-selector flex-1 px-2 py-2 rounded-lg cursor-pointer transition border-2 text-slate-600 bg-white hover:bg-drk-100" 
                                id="mode-overall-best-label">
                            <input type="radio" name="comparison_mode" value="overall_best" id="mode-overall-best" class="hidden">
                            <!-- NUEVA ESTRUCTURA CON DOS LÍNEAS -->
                            <span class="font-black flex flex-col items-center justify-center w-full leading-tight">
                                <span class="text-base">POWER CUP</span>
                                <span class="text-xs font-semibold -mt-0.5">Global</span>
                            </span>
                            <svg class="w-4 h-4 ml-1 checkmark-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="visibility: hidden;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </label>
                    </div>
                </div>
                <!-- END: NEW COMPARISON MODE SELECTORS -->
                <!-- El logo se inyecta aquí por JS -->
                <div id="initial-icon-bg" class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600">
                    <!-- Contenido inicial que será reemplazado en initApp por el logo DRK -->
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Analizar Factura</h2>
                <p class="text-slate-500 mb-6">Escanea el código QR de la CNMC.</p>
                <button id="start-scan-btn" class="w-full bg-gradient-to-r from-drk-600 to-drk-800 hover:from-drk-700 hover:to-drk-900 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.125 3h3.75a2 2 0 011.664.89l.812 1.22a2 2 0 001.664.89H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span>ESCANEAR QR AHORA</span>
                </button>
                <input type="file" id="image-file-input" accept="image/*" class="hidden">
                <button id="upload-menu-btn" class="w-full bg-drk-50 hover:bg-drk-100 text-drk-800 font-bold py-3 px-6 rounded-xl shadow-sm transform transition active:scale-95 flex items-center justify-center gap-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1m-4-5l-1-1m0 0l-1-1m0 0l-1-1M12 12v.01"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span>OPCIONES QR MANUAL</span>
                </button>
                <p id="loading-status" class="text-center text-sm text-slate-400 mt-4 hidden">Cargando tarifas...</p>

                <!-- START: PWA Installation QR Code Section -->
                <div id="pwa-install-section" class="mt-8 pt-4 border-t border-slate-200">
                    <label class="flex items-center justify-center cursor-pointer mb-3 text-drk-800 hover:text-drk-900 transition">
                        <input type="checkbox" id="qr-toggle-checkbox" class="h-4 w-4 text-drk-500 border-gray-300 rounded focus:ring-drk-500 mr-2">
                        <!-- Título más pequeño: text-xs -->
                        <span class="text-xs font-bold uppercase tracking-wider underline decoration-drk-500 decoration-2 underline-offset-4">Abrir en el Movil</span>
                    </label>
                    
                    <!-- Contenedor desplegable -->
                    <div id="qr-content-wrapper" class="opacity-0 max-h-0">
                        
                        <!-- Contenedor visual para el QR con logo (estilo de la imagen adjunta) -->
                        <div id="qr-visual-container" class="mx-auto w-44 h-44 p-2" 
                             style="--qr-border-color: #0ea5e9; --qr-center-bg: #0c4a6e; --qr-center-text: 'DRK';">
                                <!-- Contenedor del QR code, con un ID para el script -->
                            <div id="qr-code-container">
                                <!-- El código QR será generado aquí por JS -->
                            </div>
                        </div>
                        
                        <p class="text-xs text-slate-500 mt-3 px-4">
                            Haz una foto del QR y ábrelo en tu móvil (iPhone/Android) para guardar el icono de **DRK - POWER** en la pantalla de inicio.
                        </p>
                    </div>
                </div>
                <!-- END: PWA Installation QR Code Section -->
            </div>
        </div>

        <!-- Vista Escáner (Ajustado para usar clases dinámicas) -->
        <div id="scanner-view" class="hidden flex-col h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-slate-700">Escaneando...</h2>
                <button id="stop-scan-btn" class="text-red-500 font-bold text-sm bg-red-50 px-3 py-1 rounded-lg">Cancelar</button>
            </div>
            <div class="relative w-full aspect-[3/4] bg-black rounded-2xl overflow-hidden shadow-2xl mb-4">
                <div id="interactive" class="viewport w-full h-full"></div>
                <!-- Guía visual del QR -->
                <div id="scanner-guide" class="absolute inset-0 border-2 border-drk-500 opacity-50 m-8 rounded-lg pointer-events-none"></div>
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="w-64 h-1 bg-red-500 opacity-50"></div>
                </div>
            </div>
            <p id="scan-message" class="text-center text-sm text-slate-500 mb-4">Enfoca el código QR de la CNMC.</p>
            <button id="capture-photo-btn" class="w-full bg-white border-2 border-drk-500 text-drk-800 font-bold py-3 rounded-xl shadow-sm flex items-center justify-center gap-2">Capturar Foto Manualmente</button>
        </div>

        <!-- Vista Resultados (Ajustado para usar clases dinámicas) -->
        <div id="results-view" class="hidden animate-fade-in-up">
            <div class="text-center mb-6">
                <div class="inline-flex items-center gap-2 bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold mb-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Análisis Completado
                </div>
                <h2 class="text-2xl font-black text-slate-800">Resultado del Estudio</h2>
                <p class="text-sm text-slate-500">CUPS: <span id="cups-value" class="font-mono text-slate-700"></span></p>
            </div>

            <!-- Tarjeta Resultado en Pantalla -->
            <div id="result-card" class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100 mb-8 relative">
                <div id="result-header" class="bg-gradient-to-r from-drk-800 to-drk-600 p-6 text-white text-center relative overflow-hidden">
                    <p class="uppercase tracking-widest text-xs font-semibold text-drk-100 mb-1" id="best-offer-label">LA MEJOR OPCIÓN PARA TI ES</p>
                    <h2 id="best-offer-name" class="text-2xl md:text-3xl font-extrabold leading-tight mb-2">Nombre Tarifa</h2>
                    <p id="best-offer-desc" class="text-drk-100 text-sm opacity-90">Descripción</p>
                </div>
                <div class="p-6">
                    <div class="flex flex-col gap-6">
                        <div class="text-center">
                            <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Tu Ahorro Anual Estimado</p>
                            <p id="savings-estimate" class="text-5xl font-black text-green-500 tracking-tight">- €</p>
                        </div>
                        <div class="w-full grid grid-cols-2 text-center text-sm border-b pb-4 border-slate-100">
                            <!-- Columna 1: Factura Actual -->
                            <div class="border-r border-slate-200 pr-2">
                                <p class="text-slate-400 text-xs font-semibold mb-2 uppercase">TU FACTURA ACTUAL</p>
                                <div class="mb-3">
                                    <p class="text-xl font-bold text-red-400 line-through decoration-red-400/50 decoration-2" id="old-period-cost-display">0,00 €</p>
                                    <p class="text-xs text-slate-500 font-medium" id="old-period-days-label">Total Periodo</p> 
                                </div>
                                <div>
                                    <p class="text-lg font-bold text-red-500 line-through decoration-red-500/50 decoration-2" id="old-annual-cost-display">0,00 €/año</p>
                                </div>
                            </div>
                            <!-- Columna 2: Nuevo Coste (DRK o Mejor) -->
                            <div class="pl-2">
                                <!-- Etiqueta de coste dinámico -->
                                <p class="text-drk-800 text-xs font-semibold mb-2 uppercase" id="new-cost-label">TU NUEVO COSTE DRK</p>
                                <div class="mb-3">
                                    <p class="text-2xl font-black text-drk-900" id="new-monthly-cost-display">0,00 €/mes</p>
                                    <p class="text-xs text-drk-800 font-medium" id="monthly-label">Estimado Mensual</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-black text-drk-900" id="new-annual-cost-display">0,00 €/año</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <div class="grid grid-cols-1 gap-3 mb-8">
                    <button id="send-offer-btn" class="w-full bg-cta-red-500 hover:bg-cta-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2m-4-4l-4 4m0 0l-4-4m4 4V5"></path></svg>
                    <span>COPIAR COMPARATIVO</span>
                </button>
                    <button onclick="document.getElementById('details-container').classList.toggle('hidden')" class="text-center text-drk-800 font-bold text-sm hover:underline flex items-center justify-center gap-1" id="details-toggle-btn">
                    Ver desglose detallado del cálculo
                </button>
            </div>

            <!-- Contenedor de Detalles (Oculto por defecto) -->
            <div id="details-container" class="hidden space-y-6">
                <h3 id="extracted-data-header" class="text-lg font-bold text-slate-800 border-l-4 border-drk-500 pl-3">Datos Extraídos</h3>
                <div id="user-consumption-details" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-sm"></div>
                <h3 class="text-lg font-bold text-slate-800 border-l-4 border-green-500 pl-3">Cálculo Oficial</h3>
                <div id="cost-breakdown" class="bg-white p-0 rounded-xl border border-slate-200 shadow-sm overflow-hidden text-sm"></div>
                <!-- Debug invisible -->
                <div id="comparison-details" class="hidden"></div> 
            </div>

            <div class="mt-8">
                <button onclick="resetApp()" class="w-full bg-white border-2 border-slate-200 hover:border-drk-500 text-slate-600 hover:text-drk-800 font-bold py-4 rounded-xl transition flex items-center justify-center gap-2" id="reset-btn">
                    Realizar Nueva Comparación
                </button>
            </div>
        </div>
        
        <!-- Modales -->
        <!-- Modal Opciones QR Manual -->
        <div id="qr-options-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-drk-800 mb-4" id="modal-qr-title">Seleccione Opción</h3>
                <button id="modal-upload-file-btn" class="w-full bg-drk-800 hover:bg-drk-900 text-white font-bold py-3 px-6 rounded-xl shadow-md mb-3">Subir Imagen</button>
                <button id="modal-paste-image-btn" class="w-full bg-drk-600 hover:bg-drk-800 text-white font-bold py-3 px-6 rounded-xl shadow-md mb-4">Pegar Imagen (CTRL+V)</button>
                <button onclick="document.getElementById('qr-options-modal').classList.add('hidden');" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-3 rounded-xl">Cancelar</button>
                <textarea id="paste-catcher" class="opacity-0 w-0 h-0 absolute -z-10" aria-hidden="true"></textarea>
            </div>
        </div>

        <!-- Modal Datos Comercial y Cliente -->
        <div id="send-offer-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-drk-800 mb-4" id="modal-client-data-title">Datos del Comercial y Cliente</h3>
                <input type="text" id="comercial-code-input" placeholder="CÓDIGO COMERCIAL (Obligatorio)" class="w-full mb-3 p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-drk-500 outline-none text-sm">
                <input type="text" id="client-name-input" placeholder="Nombre Cliente (Opcional)" class="w-full mb-3 p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-drk-500 outline-none text-sm">
                <input type="tel" id="client-phone-input" placeholder="Teléfono Cliente (Opcional)" class="w-full mb-3 p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-drk-500 outline-none text-sm">
                <input type="email" id="client-email-input" placeholder="Email Cliente (Opcional)" class="w-full mb-4 p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-drk-500 outline-none text-sm">
                
                <!-- Botón de Copiar HTML (función original) -->
                <button id="execute-send-offer-btn" class="w-full bg-cta-red-500 hover:bg-cta-red-600 text-white font-bold py-3 rounded-xl shadow-md mb-3">COPIAR COMPARATIVO (HTML)</button>
                
                <button onclick="document.getElementById('send-offer-modal').classList.add('hidden');" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-3 rounded-xl text-sm">Cancelar</button>
            </div>
        </div>

        <!-- Modal de Error/Mensaje -->
        <div id="error-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center">
                <!-- Icono de Error por defecto -->
                <div class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4" id="error-icon"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                <h3 class="text-lg font-bold text-slate-800 mb-2" id="error-title">¡Ups! Algo salió mal</h3>
                <p id="error-message" class="text-slate-600 text-sm mb-6"></p>
                <button onclick="hideErrorModal()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl">Entendido</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT PRINCIPAL -->
    <script>
        // --- CONSTANTES GLOBALES DE MARCA ---
        const BRANDS = {
            DRK: {
                NAME: 'DRK Energía',
                ACCENT: 'drk-500',
                PRIMARY_BG_GRADIENT: 'from-drk-800 to-drk-600',
                PRIMARY_BUTTON: 'from-drk-600 to-drk-800 hover:from-drk-700 hover:to-drk-900',
                PRIMARY_TEXT: 'text-drk-800',
                SECONDARY_BG: 'bg-drk-50',
                SECONDARY_TEXT: 'text-drk-600',
                BORDER: 'border-drk-500',
                // SVG del logo DRK (anillos de colores) - AJUSTADO PARA MAYOR FIDELIDAD
                LOGO_SVG: `
                    <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <style>
                            /* Usamos colores sólidos y ajustamos la posición para superposición */
                            .drk-ring{fill:none;stroke-width:10;stroke-linecap:round;}
                        </style>
                        <!-- Anillo Rojo (Top-Left) -->
                        <circle class="drk-ring" cx="45" cy="45" r="35" stroke="#E50000"/>
                        <!-- Anillo Amarillo (Bottom-Right) -->
                        <circle class="drk-ring" cx="55" cy="55" r="35" stroke="#FFCC00"/>
                        <!-- Anillo Azul (Bottom-Left) -->
                        <circle class="drk-ring" cx="45" cy="55" r="35" stroke="#0079C1"/>
                        <!-- Anillo Verde (Top-Right) -->
                        <circle class="drk-ring" cx="55" cy="45" r="35" stroke="#00A859"/>
                    </svg>
                `,
                NAV_BG: 'bg-drk-900',
                NAV_SUBTITLE_BG: 'bg-drk-800',
                NAV_SUBTITLE_TEXT: 'text-drk-100'
            },
            POWER_CUP: {
                NAME: 'Power Cup',
                ACCENT: 'powercup-500',
                PRIMARY_BG_GRADIENT: 'from-powercup-900 to-powercup-800', // Verde oscuro/casi negro
                PRIMARY_BUTTON: 'from-powercup-600 to-powercup-800 hover:from-powercup-500 hover:to-powercup-900', // Gradiente de verde
                PRIMARY_TEXT: 'text-powercup-800',
                SECONDARY_BG: 'bg-powercup-50',
                SECONDARY_TEXT: 'text-powercup-600',
                BORDER: 'border-powercup-500',
                // SVG del logo PowerCup (Taza/Batería)
                LOGO_SVG: `
                    <svg width="40" height="40" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- Taza y Sombra -->
                        <path d="M78 40V70C78 80.25 70.25 88 60 88H30C19.75 88 12 80.25 12 70V40C12 29.75 19.75 22 30 22H60C70.25 22 78 29.75 78 40Z" fill="#3f6212"/>
                        <circle cx="45" cy="95" r="5" fill="#365314" opacity="0.8"/>
                        
                        <!-- Base -->
                        <rect x="20" y="80" width="50" height="5" rx="2.5" fill="#365314"/>
                        
                        <!-- Contenido (Batería) -->
                        <rect x="20" y="30" width="50" height="50" fill="#f7fee7" rx="5"/>
                        <rect x="25" y="65" width="40" height="10" rx="2" fill="#84cc16"/>
                        <rect x="25" y="50" width="40" height="10" rx="2" fill="#84cc16"/>
                        <rect x="25" y="35" width="40" height="10" rx="2" fill="#84cc16"/>
                        
                        <!-- Rayo (Flash) -->
                        <path d="M80 20L60 35L70 45L50 60L75 60L65 80L85 65L75 55L85 45L65 45L75 25Z" fill="#facc15" stroke="#3f6212" stroke-width="2" stroke-linejoin="round"/>
                        
                        <!-- Asa de la taza -->
                        <path d="M78 40C88 40 88 50 88 60C88 70 88 80 78 80" stroke="#3f6212" stroke-width="8" stroke-linecap="round"/>
                    </svg>
                `,
                NAV_BG: 'bg-powercup-900', // Fondo navbar Power Cup
                NAV_SUBTITLE_BG: 'bg-powercup-800',
                NAV_SUBTITLE_TEXT: 'text-powercup-100'
            }
        };

        const SHEET_ID = '1ckm7zBaaMQ-6uxB-s3iXBYXXIrrg_Eslo8obcH9pCVc'; // Nuevo ID de Google Sheet
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=0`;
        const ANNUAL_DAYS = 365;
        const LOCAL_STORAGE_KEY = 'drk_loaded_tariffs';
        // NUEVA URL EXTERNA PARA EL QR DE INSTALACIÓN (Fijo)
        const EXTERNAL_APP_URL = 'https://faraujoteixeiradrk-creator.github.io/CALCULADORA-DRK-POWER-QR-CAMBIANDO-COLORES-DESCUENTO-y-DESCAR-TLF/';

        let currentTariffs = [];
        let lastComparisonResult = null;
        let scannerRunning = false;
        let stream = null, video = null, canvas = null, canvasCtx = null, animationFrameId = null;
        let comparisonMode = 'drk_prioritized'; // Default mode (DRK Prioritario)
        let activeBrand = BRANDS.DRK; // Controla la marca activa para la UI

        // Referencias a elementos del DOM
        const els = {
            // Elementos de la marca global
            appTitle: document.getElementById('app-title'),
            appLogoText: document.getElementById('app-logo-text'),
            appLogoAccent: document.getElementById('app-logo-accent'),
            appSubtitle: document.getElementById('app-subtitle'),
            navbar: document.getElementById('navbar'),
            initialCard: document.getElementById('initial-card'),
            tariffBadge: document.getElementById('tariff-badge'),
            modeSelectorContainer: document.getElementById('mode-selector-container'),
            initialIconBg: document.getElementById('initial-icon-bg'),
            startScanBtn: document.getElementById('start-scan-btn'),
            capturePhotoBtn: document.getElementById('capture-photo-btn'),
            scannerGuide: document.getElementById('scanner-guide'),
            detailsToggleBtn: document.getElementById('details-toggle-btn'),
            extractedDataHeader: document.getElementById('extracted-data-header'),
            resetBtn: document.getElementById('reset-btn'),
            
            // Elementos de vista
            initialView: document.getElementById('initial-view'),
            resultsView: document.getElementById('results-view'),
            scannerView: document.getElementById('scanner-view'),
            interactiveViewport: document.getElementById('interactive'),
            stopScanBtn: document.getElementById('stop-scan-btn'),
            loadingStatus: document.getElementById('loading-status'),
            
            // Elementos de Resultados
            resultCard: document.getElementById('result-card'),
            resultHeader: document.getElementById('result-header'),
            sendOfferBtn: document.getElementById('send-offer-btn'),
            newCostLabel: document.getElementById('new-cost-label'),
            monthlyLabel: document.getElementById('monthly-label'),
            cupsValue: document.getElementById('cups-value'),
            bestOfferName: document.getElementById('best-offer-name'),
            bestOfferDesc: document.getElementById('best-offer-desc'),
            savingsEstimate: document.getElementById('savings-estimate'),
            oldAnnualCostDisplay: document.getElementById('old-annual-cost-display'),
            newAnnualCostDisplay: document.getElementById('new-annual-cost-display'),
            oldPeriodCostDisplay: document.getElementById('old-period-cost-display'), 
            oldPeriodDaysLabel: document.getElementById('old-period-days-label'), 
            newMonthlyCostDisplay: document.getElementById('new-monthly-cost-display'), 
            userConsumptionDetails: document.getElementById('user-consumption-details'),
            costBreakdown: document.getElementById('cost-breakdown'),
            
            // Elementos de Modal
            sendOfferModal: document.getElementById('send-offer-modal'),
            comercialCodeInput: document.getElementById('comercial-code-input'),
            clientNameInput: document.getElementById('client-name-input'),
            clientPhoneInput: document.getElementById('client-phone-input'),
            clientEmailInput: document.getElementById('client-email-input'),
            executeSendOfferBtn: document.getElementById('execute-send-offer-btn'),
            tariffDisplayBadge: document.getElementById('tariff-display-badge'),
            uploadMenuBtn: document.getElementById('upload-menu-btn'),
            imageFileInput: document.getElementById('image-file-input'),
            qrOptionsModal: document.getElementById('qr-options-modal'),
            modalPasteImageBtn: document.getElementById('modal-paste-image-btn'), 
            pasteCatcher: document.getElementById('paste-catcher'), 
            
            // Nuevo elemento para el QR de instalación
            qrCodeContainer: document.getElementById('qr-code-container'),
            qrToggleCheckbox: document.getElementById('qr-toggle-checkbox'),
            qrContentWrapper: document.getElementById('qr-content-wrapper'),
            qrVisualContainer: document.getElementById('qr-visual-container'),
        };

        // --- FUNCIÓN DE ACTUALIZACIÓN DE MARCA GLOBAL (DRK o POWER CUP) ---
        function applyBrandStyles(brand) {
            activeBrand = brand;
            const isDrk = brand.NAME === 'DRK Energía';
            const basePrefix = isDrk ? 'drk' : 'powercup';
            
            // 1. Navbar
            els.navbar.className = `w-full ${brand.NAV_BG} text-white p-4 shadow-md sticky top-0 z-50`;
            els.appLogoText.innerHTML = `${isDrk ? 'DRK' : 'POWER'} <span class="text-${brand.ACCENT}" id="app-logo-accent">${isDrk ? 'Energía' : 'CUP'}</span>`;
            els.appSubtitle.className = `text-xs ${brand.NAV_SUBTITLE_BG} px-2 py-1 rounded ${brand.NAV_SUBTITLE_TEXT}`;

            // 2. Initial View Card
            // Limpieza de clases anteriores
            els.initialCard.classList.forEach(c => {
                if (c.startsWith('border-t-4-drk') || c.startsWith('border-t-4-powercup')) { els.initialCard.classList.remove(c); }
            });
            els.initialCard.classList.add(`border-t-4`, brand.BORDER);

            // Badge
            els.tariffBadge.classList.remove('bg-drk-500', 'bg-powercup-500');
            els.tariffBadge.classList.add(`bg-${basePrefix}-500`);
            
            // Icon BG
            els.initialIconBg.classList.remove('bg-drk-50', 'text-drk-600', 'bg-powercup-50', 'text-powercup-600');
            els.initialIconBg.classList.add(brand.SECONDARY_BG, brand.SECONDARY_TEXT);
            els.initialIconBg.innerHTML = brand.LOGO_SVG; // <--- **AQUÍ SE INYECTA EL LOGO DRK/POWER CUP**

            // Start Scan Button
            els.startScanBtn.className = `w-full bg-gradient-to-r ${brand.PRIMARY_BUTTON} text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3`;
            
            // Upload Menu Button
            els.uploadMenuBtn.classList.remove('bg-drk-50', 'hover:bg-drk-100', 'text-drk-800', 'bg-powercup-50', 'hover:bg-powercup-100', 'text-powercup-800');
            els.uploadMenuBtn.classList.add(brand.SECONDARY_BG, `hover:bg-${basePrefix}-100`, brand.PRIMARY_TEXT);
            
            // Comparison Mode Selectors (will be handled by updateComparisonMode)
            
            // Scanner View Guide
            els.scannerGuide.classList.remove('border-drk-500', 'border-powercup-500');
            els.scannerGuide.classList.add(brand.BORDER);

            // Capture Photo Button
            els.capturePhotoBtn.classList.remove('border-drk-500', 'text-drk-800', 'border-powercup-500', 'text-powercup-800');
            els.capturePhotoBtn.classList.add('border-2', brand.BORDER, brand.PRIMARY_TEXT);

            // Details Headers
            els.extractedDataHeader.classList.remove('border-drk-500', 'border-powercup-500');
            els.extractedDataHeader.classList.add(brand.BORDER);
            
            // Reset button
            els.resetBtn.classList.remove('hover:border-drk-500', 'hover:text-drk-800', 'hover:border-powercup-500', 'hover:text-powercup-800');
            els.resetBtn.classList.add(`hover:${brand.BORDER}`, `hover:${brand.PRIMARY_TEXT}`);

            // Update modal headers (simplified to the new primary text class)
            const modalTitles = document.querySelectorAll('#modal-qr-title, #modal-client-data-title');
            modalTitles.forEach(h => {
                h.classList.remove('text-drk-800', 'text-powercup-800');
                h.classList.add(brand.PRIMARY_TEXT);
            });
            
            // Nota: generateInstallQR debe llamarse después de cambiar el comparisonMode si es necesario.
        }
        
        // Función para cambiar la marca activa y re-renderizar la UI inicial
        function setActiveBrand(offer) {
            let targetBrand = BRANDS.DRK;
            // Si el modo es 'overall_best' O si la mejor oferta no es DRK
            if (comparisonMode === 'overall_best' || (lastComparisonResult && !offer.isDrk)) {
                // Si la mejor oferta es DRK, mantenemos DRK. Si no, cambiamos a Power Cup.
                if (offer.isDrk || lastComparisonResult.isNegativeSavings) {
                    targetBrand = BRANDS.DRK; 
                } else {
                    targetBrand = BRANDS.POWER_CUP;
                }
            } else {
                // Si el modo es 'drk_only' o 'drk_prioritized'
                targetBrand = BRANDS.DRK;
            }
            applyBrandStyles(targetBrand);
            return targetBrand;
        }

        function updateTariffCount() { 
            els.tariffDisplayBadge.textContent = currentTariffs.length;
            if (currentTariffs.length > 0) {
                els.loadingStatus.classList.add('hidden');
                els.startScanBtn.disabled = false;
                els.uploadMenuBtn.disabled = false;
            } else {
                els.loadingStatus.textContent = "Error: No hay tarifas disponibles. Verifique permisos de Google Sheet.";
                els.loadingStatus.classList.remove('hidden');
                els.startScanBtn.disabled = true;
                els.uploadMenuBtn.disabled = true;
            }
        }
        function loadTariffsFromStorage() { try { const stored = localStorage.getItem(LOCAL_STORAGE_KEY); if (stored) return JSON.parse(stored); } catch (e) { console.error("Storage Error", e); } return []; }
        function saveTariffsToStorage(tariffs) { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(tariffs)); }
        
        // Lógica robusta para parsear el CSV (manejo de delimitadores y quotes)
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) throw new Error("Archivo CSV vacío.");
            if (lines[0].toLowerCase().includes('<html')) throw new Error("Error de acceso (HTML devuelto).");
            
            let rawHeaders = lines[0].trim();
            
            // Detección dinámica del delimitador: Coma o Punto y Coma
            let delimiter = ',';
            if ((lines[1] && lines[1].includes(';') && !lines[1].includes(',')) || rawHeaders.includes(';')) {
                delimiter = ';';
            }
            
            const headers = rawHeaders.split(delimiter).map(h => h.trim().toLowerCase().replace(/"/g, ''));
            // AÑADIDO 'descuento' como cabecera requerida
            const requiredHeaders = ['name', 'description', 'p1_price', 'p2_price', 'p3_price', 'p_potencia_1', 'p_potencia_2', 'descuento'];
            if (!requiredHeaders.every(h => headers.includes(h))) throw new Error(`Faltan cabeceras. (Delimitador usado: "${delimiter}")`);

            const newTariffs = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Parsing robusto con soporte de comillas
                const values = [];
                let current = '';
                let inQuotes = false;

                for (let k = 0; k < line.length; k++) {
                    const char = line[k];
                    if (char === '"') {
                        if (k + 1 < line.length && line[k+1] === '"') {
                            current += '"';
                            k++; 
                        } else {
                            inQuotes = !inQuotes;
                        }
                    }
                    else if (char === delimiter && !inQuotes) {
                        values.push(current); 
                        current = '';
                    }
                    else { 
                        current += char; 
                    }
                }
                values.push(current); 

                if (values.length !== headers.length) continue;
                
                const tariff = { cups_match: ["2.0TD"] };
                let isValidTariff = true;
                for (let j = 0; j < headers.length; j++) {
                    const header = headers[j];
                    const value = values[j].trim().replace(/^"|"$/g, ''); 
                    
                    // Incluir 'descuento' en la lógica de parseo de números
                    if (header.includes('price') || header.includes('potencia') || header === 'descuento') {
                        // Crucial: Reemplazar coma por punto para el parsing de números
                        const numValue = parseFloat(value.replace(',', '.')); 
                        if (!isNaN(numValue)) { 
                            tariff[header] = numValue; 
                        } else { 
                            // Manejar descuento faltante/inválido: forzar a 0%
                            if (header === 'descuento') {
                                tariff[header] = 0;
                            } else {
                                isValidTariff = false; 
                                break; 
                            }
                        }
                    } else { 
                        tariff[header] = value; 
                    }
                }
                
                // Determinar si la tarifa es DRK
                tariff.isDrk = tariff.name ? tariff.name.toUpperCase().includes('DRK') : false;

                if (isValidTariff && tariff.p1_price !== undefined) newTariffs.push(tariff);
            }
            return newTariffs;
        }

        async function fetchTariffsFromSheet() {
            els.loadingStatus.textContent = "Cargando tarifas...";
            els.loadingStatus.classList.remove('hidden');

            const fetchAndParse = async (url) => {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                const csvText = await response.text();
                const loaded = parseCSV(csvText);
                if (loaded.length === 0) throw new Error("No se encontraron tarifas.");
                return loaded;
            };

            let successful = false;
            const urlsToTry = [
                SHEET_URL, 
                `${SHEET_URL}&t=${Date.now()}` // Para evitar problemas de caché
            ];

            for (let i = 0; i < urlsToTry.length; i++) {
                const url = urlsToTry[i];
                try {
                    if (i > 0) {
                            els.loadingStatus.textContent = "Reintentando carga de tarifas...";
                    }
                    const loaded = await fetchAndParse(url);
                    currentTariffs = loaded;
                    saveTariffsToStorage(currentTariffs);
                    successful = true;
                    break;
                } catch (err) {
                    console.error(`Error fetching (Intento ${i + 1}):`, err.message);
                }
            }
            
            if (!successful) {
                currentTariffs = loadTariffsFromStorage();
                if (currentTariffs.length === 0) {
                    window.showErrorModal("Error crítico: No se pudieron cargar tarifas desde el servidor. Verifique que la hoja de cálculo esté configurada como **pública (Cualquier persona con el enlace puede ver)**.");
                } else {
                    els.loadingStatus.textContent = `Error de red. Usando ${currentTariffs.length} tarifas de la caché.`;
                }
            }
            
            updateTariffCount();
        }

        function dateDiffInDays(d1, d2) {
            const parse = (str) => {
                if (!str || str.length !== 10) return null;
                // Formato DD/MM/YYYY (común en España) o YYYY-MM-DD
                if (str.includes('/')) { const p = str.split('/'); return new Date(p[2], p[1]-1, p[0]); }
                if (str.includes('-')) { const p = str.split('-'); return new Date(p[0], p[1]-1, p[2]); }
                // YYYYMMDD (algunos QR lo usan)
                if (str.length === 8) { const y = str.substring(0,4), m = str.substring(4,6), d = str.substring(6,8); return new Date(y, m-1, d); }
                return null;
            }
            const dt1 = parse(d1), dt2 = parse(d2);
            if(!dt1 || !dt2) return 0;
            return Math.ceil(Math.abs(dt2 - dt1) / (1000 * 60 * 60 * 24)) + 1;
        }

        function handleQRRead(raw) {
            stopScanner(); // Detener el escáner inmediatamente
            if (raw.includes('?')) raw = raw.split('?')[1] || raw;
            const p = {};
            raw.split('&').forEach(part => { const [k, v] = part.split('='); if(k) p[k] = decodeURIComponent(v||'').replace(',', '.'); });
            
            const data = {
                cups: p.cups || 'No detectado',
                dias_facturados: dateDiffInDays(p.iniF, p.finF),
                consumo_punta: parseFloat(p.cfP1||0),
                consumo_llano: parseFloat(p.cfP2||0),
                consumo_valle: parseFloat(p.cfP3||0),
                consumo_total: parseFloat(p.cfP1||0)+parseFloat(p.cfP2||0)+parseFloat(p.cfP3||0),
                potencia_p1_kw: parseFloat(p.pP1||0),
                potencia_p2_kw: parseFloat(p.pP2||0),
                importe_total: parseFloat(p.imp||0), 
                fechas: `${p.iniF || '?'} - ${p.finF || '?'}`
            };

            if (data.dias_facturados === 0 || data.importe_total === 0) {
                window.showErrorModal("QR incompleto o inválido. Asegúrese de que la factura tenga un período de facturación definido e importe total.");
                window.resetApp();
                return;
            }
            compareOffers(data);
        }
        
        // --- CÁLCULO DE COSTE PARA UNA TARIFA ÚNICA ---
        function calculateTariffCost(tariff, data) {
            const IVA_RATE = 0.21;
            const IE_RATE = 0.05113; // Impuesto Eléctrico (tasa fija)
            const ANNUAL_DAYS_CONST = 365;

            // Coste de la Potencia (Término Fijo) - Se calcula el coste por día para aplicarlo a los días facturados
            const priceP1Day = tariff.p_potencia_1 / ANNUAL_DAYS_CONST;
            const priceP2Day = tariff.p_potencia_2 / ANNUAL_DAYS_CONST;
            
            const costP1 = data.potencia_p1_kw * data.dias_facturados * priceP1Day;
            const costP2 = data.potencia_p2_kw * data.dias_facturados * priceP2Day;
            const subPower = costP1 + costP2;

            // Coste de la Energía (Término Variable) - Subtotal Bruto
            const costE1 = data.consumo_punta * tariff.p1_price;
            const costE2 = data.consumo_llano * tariff.p2_price;
            const costE3 = data.consumo_valle * tariff.p3_price;
            const subEnergy = costE1 + costE2 + costE3;
            
            // APLICAR DESCUENTO
            const discountRate = (tariff.descuento || 0) / 100; // Convertir 5 (número entero) a 0.05 (tasa)
            const discountAmount = subEnergy * discountRate;
            const subEnergyWithDiscount = subEnergy - discountAmount;

            // Coste Base (Potencia + Energía Neta)
            const subBase = subPower + subEnergyWithDiscount; 
            
            // Impuestos y cargos
            const costIE = subBase * IE_RATE;
            const baseImp = subBase + costIE; // Base Imponible (antes de IVA)
            const costIVA = baseImp * IVA_RATE;
            
            const totalPeriod = baseImp + costIVA; // Coste total de la factura
            
            // Proyección Anual
            const factorAnual = ANNUAL_DAYS_CONST / data.dias_facturados;
            const totalAnnual = totalPeriod * factorAnual; 
            const originalBillAnnual = data.importe_total * factorAnual;

            return {
                ...data, 
                costP1, costP2, subPower, 
                costE1, costE2, costE3, 
                subEnergy, // Bruto
                discountRate, discountAmount, subEnergyWithDiscount, // Descuento
                subBase, costIE, baseImp, costIVA, totalPeriod, totalAnnual,
                priceP1Day, priceP2Day, IE_RATE,
                originalBillAnnual, 
                savings: originalBillAnnual - totalAnnual,
                offer: tariff
            };
        }


        // --- FUNCIÓN PRINCIPAL DE COMPARACIÓN (IMPLEMENTA LOS 3 MODOS) ---
        function compareOffers(data) {
            
            // 1. Calcular costes para todas las tarifas disponibles
            const allComparisons = currentTariffs.map(t => calculateTariffCost(t, data));

            let bestOverallComparison = null;
            let bestDrkComparison = null;

            // Encontrar la mejor opción general y la mejor opción DRK
            allComparisons.forEach(c => {
                // Mejor General (la que más ahorra o la que menos pierde)
                if (!bestOverallComparison || c.savings > bestOverallComparison.savings) {
                    bestOverallComparison = c;
                }
                // Mejor DRK (solo si la tarifa es DRK)
                if (c.offer.isDrk) {
                    if (!bestDrkComparison || c.savings > bestDrkComparison.savings) {
                        bestDrkComparison = c;
                    }
                }
            });

            if (!bestOverallComparison) {
                return window.showErrorModal("No se encontraron tarifas válidas para la comparación.");
            }

            let finalComparisonResult = null;
            
            // 2. Lógica basada en el comparisonMode
            if (comparisonMode === 'drk_only') {
                // Modo 1: Solo DRK. Si hay, usamos la mejor DRK. Si no, usamos la mejor general.
                finalComparisonResult = bestDrkComparison || bestOverallComparison;
            } else if (comparisonMode === 'drk_prioritized') {
                // Modo 2: DRK Prioritario. Si la mejor DRK ahorra dinero, la usamos. Si no, mostramos la mejor opción ABSOLUTA.
                if (bestDrkComparison && bestDrkComparison.savings > 0) {
                    finalComparisonResult = bestDrkComparison;
                } else {
                    finalComparisonResult = bestOverallComparison;
                }
            } else if (comparisonMode === 'overall_best') {
                // Modo 3: Mejor en el Mercado. Elegimos la mejor opción ABSOLUTA encontrada.
                finalComparisonResult = bestOverallComparison;
            }
            
            // Aseguramos que siempre haya un resultado válido (al menos el mejor general)
            if (!finalComparisonResult) {
                finalComparisonResult = bestOverallComparison;
            }

            // 3. Manejo de Ahorro Negativo/Cero
            if (finalComparisonResult.savings <= 0) {
                // Si la mejor opción calculada no ahorra o es negativa, asumimos que la tarifa del cliente es la mejor.
                // Usamos la información del cliente pero marcamos el flag isNegativeSavings.
                // En este caso, el ahorro será 0, y el 'Nuevo Coste' será igual al 'Coste Actual'.
                lastComparisonResult = { 
                    ...finalComparisonResult, 
                    savings: 0,
                    totalAnnual: finalComparisonResult.originalBillAnnual, // El nuevo coste es el coste actual
                    offer: { name: "Tarifa Actual", description: "La tarifa que el cliente ya tiene contratada", isDrk: true }, // Marcamos como DRK (o neutral) para que aplique el tema DRK/neutro
                    isNegativeSavings: true 
                };
            } else {
                lastComparisonResult = { ...finalComparisonResult, isNegativeSavings: false };
            }

            // 4. Aplicar la marca antes de renderizar los resultados (Este controlará el resultado final)
            setActiveBrand(lastComparisonResult.offer);

            renderResultsUI(lastComparisonResult.offer, lastComparisonResult);
            showView('results-view');
        }

        // --- FUNCIÓN DE RENDERIZADO DE RESULTADOS ---
        function renderResultsUI(offer, bd) {
            const brand = activeBrand; // Usar la marca activa

            // Formateadores
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n);
            const numPrice = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 8, maximumFractionDigits: 8 }).format(n);

            els.cupsValue.textContent = bd.cups;
            
            // 1. Limpieza de estilos dinámicos (para re-renderizados)
            const oldCostElements = document.querySelectorAll('#results-view .grid-cols-2 > div:first-child p');
            oldCostElements.forEach(p => {
                p.classList.remove('text-green-500', 'text-red-500', 'line-through', 'decoration-red-400/50', 'decoration-red-500/50', 'decoration-2', 'font-bold', 'text-red-400', 'text-red-500', 'text-xl', 'text-lg');
            });
            // Re-aplicar estilos base
            document.getElementById('old-period-cost-display').classList.add('text-xl'); 
            document.getElementById('old-annual-cost-display').classList.add('text-lg');

            // 2. Aplicar estilos de marca a la tarjeta de resultados
            els.resultHeader.className = `bg-gradient-to-r ${brand.PRIMARY_BG_GRADIENT} p-6 text-white text-center relative overflow-hidden`;
            els.bestOfferDesc.className = `text-${brand.ACCENT.replace('500', '100')} text-sm opacity-90`; // e.g. text-drk-100 or text-powercup-100
            els.newCostLabel.className = `${brand.PRIMARY_TEXT} text-xs font-semibold mb-2 uppercase`;
            els.newMonthlyCostDisplay.className = `text-2xl font-black text-${brand.ACCENT.replace('500', '900')}`;
            els.newAnnualCostDisplay.className = `text-2xl font-black text-${brand.ACCENT.replace('500', '900')}`;
            els.monthlyLabel.className = `text-xs ${brand.PRIMARY_TEXT} font-medium`;
            
            // 3. Renderizado de Contenido
            if (bd.isNegativeSavings) {
                // A. Escenario: No mejor opción/Ahorro 0.00
                els.bestOfferName.textContent = "¡Estás en la Mejor Opción!";
                els.bestOfferDesc.textContent = "Tu tarifa actual es la más competitiva del mercado. Seguiremos estudiando.";
                
                // Savings Display
                els.savingsEstimate.textContent = "0,00 €";
                els.savingsEstimate.className = `text-5xl font-black ${brand.PRIMARY_TEXT} tracking-tight`; // Color principal de la marca
                
                // Current Bill Display (Green/No Strikethrough)
                els.oldPeriodCostDisplay.textContent = eur(bd.importe_total);
                els.oldAnnualCostDisplay.textContent = eur(bd.originalBillAnnual) + "/año";
                els.oldPeriodCostDisplay.classList.add('text-green-500', 'font-bold');
                els.oldAnnualCostDisplay.classList.add('text-green-500', 'font-bold');
                
                // New Cost Display should reflect original cost (as there's no better offer)
                els.newMonthlyCostDisplay.textContent = eur(bd.originalBillAnnual / 12) + "/mes";
                els.newAnnualCostDisplay.textContent = eur(bd.originalBillAnnual) + "/año";
                
            } else {
                // B. Escenario: Ahorro positivo
                els.bestOfferName.textContent = offer.name;
                els.bestOfferDesc.textContent = offer.description;
                els.savingsEstimate.textContent = eur(bd.savings);
                els.savingsEstimate.className = `text-5xl font-black text-green-500 tracking-tight`; // Ahorro Positivo en verde
                
                // Current Bill Display (Red/Strikethrough)
                els.oldPeriodCostDisplay.textContent = eur(bd.importe_total);
                els.oldAnnualCostDisplay.textContent = eur(bd.originalBillAnnual) + "/año";
                els.oldPeriodCostDisplay.classList.add('line-through', 'text-red-400', 'decoration-red-400/50', 'decoration-2', 'font-bold');
                els.oldAnnualCostDisplay.classList.add('line-through', 'text-red-500', 'decoration-red-500/50', 'decoration-2', 'font-bold');

                // New cost displays (The calculated offer cost)
                els.newMonthlyCostDisplay.textContent = eur(bd.totalAnnual / 12) + "/mes";
                els.newAnnualCostDisplay.textContent = eur(bd.totalAnnual) + "/año";
            }
            
            // Datos Estándar
            els.oldPeriodDaysLabel.textContent = `Total Periodo (${bd.dias_facturados} días)`;

            // Desglose de Consumo del Cliente
            els.userConsumptionDetails.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div><p class="text-xs text-slate-500">Periodo</p><p class="font-bold text-slate-700">${bd.dias_facturados} días</p></div>
                    <div><p class="text-xs text-slate-500">Fechas</p><p class="font-bold text-slate-700">${bd.fechas}</p></div>
                    <div class="col-span-2 border-t pt-2 mt-2">
                        <p class="font-bold ${brand.PRIMARY_TEXT} mb-2">Consumo por Periodo (kWh)</p>
                        <div class="flex justify-between text-xs mb-1"><span>E1 (Punta)</span><span class="font-mono">${num(bd.consumo_punta,0)} kWh</span></div>
                        <div class="flex justify-between text-xs mb-1"><span>E2 (Llano)</span><span class="font-mono">${num(bd.consumo_llano,0)} kWh</span></div>
                        <div class="flex justify-between text-xs mb-1"><span>E3 (Valle)</span><span class="font-mono">${num(bd.consumo_valle,0)} kWh</span></div>
                        <div class="flex justify-between font-bold ${brand.PRIMARY_TEXT} mt-1 border-t pt-1"><span>Total Consumo</span><span>${num(bd.consumo_total,0)} kWh</span></div>
                    </div>
                    <div class="col-span-2">
                        <p class="font-bold ${brand.PRIMARY_TEXT} mb-2">Potencia Contratada (kW)</p>
                        <div class="flex justify-between text-xs mb-1"><span>P1</span><span class="font-mono">${num(bd.potencia_p1_kw,2)} kW</span></div>
                        <div class="flex justify-between text-xs mb-1"><span>P2</span><span class="font-mono">${num(bd.potencia_p2_kw,2)} kW</span></div>
                    </div>
                </div>
            `;

            // Desglose del Coste de la Tarifa
            els.costBreakdown.innerHTML = `
                <div class="bg-white p-6 font-mono text-xs md:text-sm text-slate-600 leading-relaxed">
                    <div class="text-center border-b-2 border-dashed border-slate-300 pb-4 mb-4">
                        <h4 class="font-bold text-lg text-slate-800 uppercase">${offer.name}</h4>
                        <p>Simulación ${bd.dias_facturados} días</p>
                    </div>
                    <div class="mb-4">
                        <p class="font-bold text-slate-800 mb-1">POTENCIA (€/kW Día)</p>
                        <div class="flex justify-between"><span>P1 (${num(bd.potencia_p1_kw,2)} kW x ${numPrice(bd.priceP1Day)})</span><span>${num(bd.costP1,2)} €</span></div>
                        <div class="flex justify-between"><span>P2 (${num(bd.potencia_p2_kw,2)} kW x ${numPrice(bd.priceP2Day)})</span><span>${num(bd.costP2,2)} €</span></div>
                        <div class="flex justify-between font-bold ${brand.SECONDARY_TEXT} border-t mt-1 pt-1"><span>Subtotal Potencia</span><span>${num(bd.subPower,2)} €</span></div>
                    </div>
                    <div class="mb-4">
                        <p class="font-bold text-slate-800 mb-1">ENERGÍA (€/kWh)</p>
                        <div class="flex justify-between"><span>E1 (${num(bd.consumo_punta,0)} kWh x ${numPrice(offer.p1_price)})</span><span>${num(bd.costE1,2)} €</span></div>
                        <div class="flex justify-between"><span>E2 (${num(bd.consumo_llano,0)} kWh x ${numPrice(offer.p2_price)})</span><span>${num(bd.costE2,2)} €</span></div>
                        <div class="flex justify-between"><span>E3 (${num(bd.consumo_valle,0)} kWh x ${numPrice(offer.p3_price)})</span><span>${num(bd.costE3,2)} €</span></div>
                        <div class="flex justify-between font-bold ${brand.SECONDARY_TEXT} border-t mt-1 pt-1"><span>Subtotal Energía (Bruto)</span><span>${num(bd.subEnergy,2)} €</span></div>
                        ${bd.discountAmount > 0 ? `
                            <div class="flex justify-between font-bold text-cta-red-500 mt-2">
                                <span>Descuento Aplicado (${num(bd.discountRate * 100, 0)}%)</span>
                                <span>-${num(bd.discountAmount, 2)} €</span>
                            </div>
                            <div class="flex justify-between font-bold text-slate-800 border-t border-dashed mt-1 pt-1">
                                <span>Subtotal Energía (Neto)</span>
                                <span>${num(bd.subEnergyWithDiscount, 2)} €</span>
                            </div>
                        ` : ''}
                    </div>
                    <!-- El fondo del TOTAL FACTURA ahora es dinámico, usando bg-powercup-900 o bg-drk-900 -->
                    <div class="border-t border-slate-200 pt-2 mb-2">
                        <div class="flex justify-between font-bold text-slate-800"><span>SUBTOTAL BASE (P+E)</span><span>${num(bd.subBase,2)} €</span></div>
                        <div class="flex justify-between"><span>Imp. Eléc. (${num(bd.IE_RATE * 100, 3)}%)</span><span>${num(bd.costIE,2)} €</span></div>
                        <div class="flex justify-between font-bold text-lg border-t mt-1 pt-1"><span>BASE IMPONIBLE</span><span>${num(bd.baseImp,2)} €</span></div>
                        <div class="flex justify-between"><span>IVA (21%)</span><span>${num(bd.costIVA,2)} €</span></div>
                    </div>
                    <div class="${brand.NAV_BG} text-white p-3 rounded-lg flex justify-between items-center text-md font-bold mb-1 mt-4"><span>TOTAL FACTURA</span><span>${eur(bd.totalPeriod)}</span></div>
                    <div class="text-center mt-2 ${brand.PRIMARY_TEXT} font-bold">Total Anual Estimado: ${eur(bd.totalAnnual)}</div>
                </div>
            `;
        }

        // --- FUNCIÓN RESTAURADA PARA COPIAR EL HTML ---
        async function handleCopyOffer() {
            if (!lastComparisonResult) return window.showErrorModal("Primero realice una comparación.");
            
            const commercialCode = els.comercialCodeInput.value.trim();
            if (!commercialCode) return window.showErrorModal("Indique el Código Comercial.");

            try {
                // 1. Generar el HTML (que incluye el mailto)
                const htmlContent = generateStyledHtmlOffer(commercialCode);
                
                // 2. Crear un elemento temporal para la copia HTML enriquecida
                const tempElement = document.createElement('div');
                tempElement.contentEditable = true;
                // El contenido generado por generateStyledHtmlOffer es un TABLE HTML completo
                tempElement.innerHTML = htmlContent;
                tempElement.style.position = 'fixed';
                tempElement.style.left = '-9999px';
                document.body.appendChild(tempElement);
                
                // Seleccionar el contenido
                const range = document.createRange();
                range.selectNodeContents(tempElement);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                
                let success = document.execCommand('copy');
                document.body.removeChild(tempElement);

                if (success) {
                    window.showMessageModal("✅ ¡Oferta copiada con éxito! Ahora puede pegar (Ctrl+V o Cmd+V) el diseño visual en su correo de escritorio.");
                    els.sendOfferModal.classList.add('hidden');
                } else {
                    // Fallback para dispositivos que no soportan copia HTML enriquecida
                    window.showErrorModal("No se pudo copiar el diseño visual. Intente desde un PC o utilice la opción de compartir si existe en su dispositivo.");
                }
            } catch (e) {
                console.error("Error al copiar al portapapeles:", e);
                window.showErrorModal(`Error de Portapapeles: ${e.message}`);
            }
        }
        
        // --- FUNCIÓN GENERATESTYLEDHTMLOFFER (GENERACIÓN DE EMAIL HTML INLINE CSS) ---
        function generateStyledHtmlOffer(commercialCode) {
            const bd = lastComparisonResult;
            const offer = bd.offer;
            const brand = activeBrand; // Usar la marca activa

            // Formateadores para el contenido del email copiado
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n);
            
            // Colores DRK
            const DRK_DARK = '#0c4a6e'; 
            const DRK_MED = '#075985';
            const DRK_CTA = '#0284c7';
            // Colores Power Cup
            const PC_DARK = '#3f6212';
            const PC_MED = '#65a30d';
            const PC_CTA = '#84cc16';

            // Colores dinámicos del email:
            const D_PRIMARY_DARK = brand.NAME === 'DRK Energía' ? DRK_DARK : PC_DARK;
            const D_PRIMARY_MED = brand.NAME === 'DRK Energía' ? DRK_MED : PC_MED;
            const D_ACCENT_CTA = brand.NAME === 'DRK Energía' ? DRK_CTA : PC_CTA;
            const D_BRAND_NAME = brand.NAME;

            const RED_CTA = '#CC0000';
            const BG_LIGHT = '#f0f9ff';
            const GREEN_SAVE = '#16a34a';

            // Capturar datos del modal o usar placeholders
            const clientName = els.clientNameInput.value.trim() || '[NOMBRE COMPLETO CLIENTE]';
            const clientPhone = els.clientPhoneInput.value.trim() || '[TELÉFONO CLIENTE]';
            const clientEmail = els.clientEmailInput.value.trim() || '[EMAIL CLIENTE]';

            // Estilos generales de tabla y celda (CRUCIAL: Usar píxeles y estilos inline para compatibilidad con email)
            const tableMain = `width: 600px; max-width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; border: 1px solid #ddd; margin: 0 auto; background: white; border-radius: 8px; overflow: hidden;`;
            const headerCell = `background-color: ${D_PRIMARY_DARK}; color: white; padding: 15px; text-align: center; border-radius: 8px 8px 0 0;`;
            const sectionTitle = `background-color: ${D_PRIMARY_MED}; color: white; font-weight: bold; padding: 8px; font-size: 14px; margin-top: 10px;`;
            const rowLabel = `padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; color: #555; vertical-align: top;`;
            const rowValue = `padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; font-weight: bold; color: #333; text-align: right; white-space: nowrap; vertical-align: top;`; // white-space: nowrap para evitar rotura de cifras
            const savingsBox = `background-color: ${D_ACCENT_CTA}; color: white; font-size: 20px; font-weight: bold; padding: 15px; text-align: center; border-radius: 8px; margin: 15px 0;`;
            const btnStyle = `display: inline-block; background-color: ${RED_CTA}; color: white; padding: 12px 24px; text-decoration: none; font-weight: bold; border-radius: 6px; margin: 20px 0; font-size: 16px;`;
            const footerStyle = `background-color: ${D_PRIMARY_MED}; height: 5px; margin-top: 10px; border-radius: 0 0 8px 8px;`;

            // --- CUERPO DEL EMAIL (Texto plano: para el mailto:) ---
            const LB = '\r\n';
            const monthlyEstimate = eur(bd.totalAnnual / 12);
            const totalConsumption = num(bd.consumo_total, 0) + ' kWh';
            
            const p1PricePerDay = numPriceFormula(bd.priceP1Day);
            const p2PricePerDay = numPriceFormula(bd.priceP2Day);
            const e1Price = numPriceFormula(offer.p1_price);
            const e2Price = numPriceFormula(offer.p2_price);
            const e3Price = numPriceFormula(offer.p3_price);

            // Línea de descuento para el cuerpo del email (mailto)
            const discountLine = bd.discountRate > 0 ? `Descuento: ${num(bd.discountRate * 100, 0)}% aplicado a Energía.${LB}` : '';

            // Cuerpo del email se ajusta a la marca ganadora
            const emailBody = `Hola ${D_BRAND_NAME.toUpperCase()}, confirmo la aceptación de la oferta con CUPS: ${bd.cups}.${LB}${LB}` +
                                 `--- DATOS DE LA OFERTA ---${LB}${LB}` +
                                 `Comercializadora y Tarifa: ${D_BRAND_NAME.toUpperCase()} - ${offer.name}${LB}` +
                                 `Zona Geográfica: PENINSULA${LB}` +
                                 `Ahorro Anual Estimado: ${eur(bd.savings)}${LB}` +
                                 `Total Mensual Estimado: ${monthlyEstimate}${LB}` +
                                 `Consumo Total Facturado: ${totalConsumption}${LB}` +
                                 `${discountLine}` + // AGREGAR DESCUENTO
                                 `--- DETALLE DE PRECIOS (€) ---${LB}` +
                                 `P1 (Potencia - €/kW/día): ${p1PricePerDay}${LB}` +
                                 `P2 (Potencia - €/kW/día): ${p2PricePerDay}${LB}` +
                                 `E1 (Energía - €/kWh): ${e1Price}${LB}` +
                                 `E2 (Energía - €/kWh): ${e2Price}${LB}` +
                                 `E3 (Energía - €/kWh): ${e3Price}${LB}` +
                                 `------------------------------${LB}${LB}` +
                                 `Por favor, utilicen los siguientes datos para tramitar mi cambio:${LB}` +
                                 `--------------------------------------------------------${LB}` +
                                 `DATOS DEL CLIENTE (A RELLENAR):${LB}` +
                                 `--------------------------------------------------------${LB}` +
                                 `Nombre completo: ${clientName}${LB}` +
                                 `Teléfono de contacto: ${clientPhone}${LB}` +
                                 `Email de contacto: ${clientEmail}${LB}${LB}` +
                                 `--------------------------------------------------------${LB}` +
                                 `INFORMACIÓN ADICIONAL (Opcional):${LB}` +
                                 `--------------------------------------------------------${LB}` +
                                 `[AGREGUE CUALQUIER COMENTARIO EXTRA AQUÍ]${LB}${LB}` +
                                 `--- DOCUMENTACIÓN REQUERIDA ---${LB}` +
                                 `Para formalizar el contrato, por favor, responde a este email adjuntando:${LB}` +
                                 `1. Foto del DNI/CIF (anverso y reverso).${LB}` +
                                 `2. Última factura (mínimo 3 meses de antigüedad).${LB}` +
                                 `3. Email de contacto para validación.${LB}` +
                                 `4. Teléfono de contacto.${LB}` +
                                 `5. Número de cuenta bancaria (IBAN).${LB}${LB}` +
                                 `Adjunto la documentación requerida.`;


            const subject = `FORMALIZACIÓN DE CONTRATO - CUPS: ${bd.cups}`; 
            // Lista de correos receptores para la formalización
            const formalizationRecipients = 'f.araujo@drk.es,r.guerra@drk.es,s.caballero@drk.es'; // Usar la lista de DRK
            const formalizationLink = `mailto:${formalizationRecipients}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            
            // --- PLANTILLA PARA AHORRO NEGATIVO (No hay mejor opción) ---
            if (bd.isNegativeSavings) {
                // ... (La plantilla de No Ahorro no necesita el desglose de descuento)
                return `
                    <table cellpadding="0" cellspacing="0" style="${tableMain}">
                        <!-- HEADER (DRK Theme) -->
                        <tr><td colspan="2" style="${headerCell}">
                            <h1 style="margin:0; font-size: 24px;">ESTUDIO DE AHORRO</h1>
                            <p style="margin:5px 0 0 0; font-size: 14px; opacity: 0.9;">COMPARATIVA PROFESIONAL - DRK ENERGÍA</p>
                        </td></tr>
                        
                        <!-- DATOS CLIENTE -->
                        <tr><td colspan="2" style="padding: 15px;">
                            <p style="margin: 0; font-size: 13px;"><strong>CLIENTE:</strong> ${clientName}</p>
                            <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>CUPS:</strong> ${bd.cups}</p>
                            <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>COMERCIAL:</strong> ${commercialCode || 'N/A'}</p>
                        </td></tr>

                        <!-- RESULTADO POSITIVO DE NO AHORRO -->
                        <tr><td colspan="2" style="background-color: ${BG_LIGHT}; padding: 25px 20px; text-align: center; border-top: 2px solid ${DRK_MED}; border-bottom: 2px solid ${DRK_MED};">
                            <div style="font-size: 60px; color: ${DRK_CTA}; margin-bottom: 10px;">
                                <span style="display: inline-block;">&#9989;</span>
                            </div>
                            <p style="margin: 0; color: ${DRK_DARK}; font-size: 22px; font-weight: bold;">¡Excelente Noticia!</p>
                            <h2 style="margin: 5px 0 10px 0; color: ${DRK_DARK}; font-size: 18px; font-weight: normal;">TU TARIFA ACTUAL ES LA MÁS COMPETITIVA DEL MERCADO</h2>
                            <p style="margin: 0; font-size: 14px; color: #555;">En este momento, no existe una oferta que mejore tu coste actual, lo que confirma que tienes una tarifa muy competitiva. Seguiremos estudiando.</p>
                        </td></tr>

                        <!-- ESTADO ACTUAL (Destacado) -->
                        <tr><td colspan="2" style="padding: 20px; text-align: center;">
                            <p style="font-size: 14px; font-weight: bold; color: ${DRK_DARK}; margin-bottom: 5px;">COSTE ANUAL ESTIMADO (ACTUAL):</p>
                            <span style="font-size: 32px; font-weight: bold; color: ${GREEN_SAVE}; display: block;">${eur(bd.originalBillAnnual)}</span>
                            <p style="font-size: 12px; color: #888;">/ AÑO (basado en el consumo de ${bd.dias_facturados} días)</p>
                            <p style="margin-top: 15px; font-size: 14px; color: #555;">[Colaborador: ${commercialCode}] | Este resumen es una simulación basada en su última factura.</p>
                        </td></tr>

                        <!-- FOOTER -->
                        <tr><td colspan="2" style="padding: 0; height: 10px;"><div style="background-color: ${DRK_MED}; height: 5px; margin-top: 10px; border-radius: 0 0 8px 8px;"></div></td></tr>
                    </table>
                `;
            }

            // --- PLANTILLA ESTÁNDAR (Ahorro Positivo) ---
            
            // Si la ganadora no es DRK, ajustamos el nombre en la tabla de precios
            const supplierName = offer.isDrk ? 'DRK ENERGÍA' : 'OTRA COMERCIALIZADORA';

            const discountRowsHtml = bd.discountAmount > 0 ? `
                <tr><td style="${rowLabel} font-weight: bold; color: #CC0000;">DESCUENTO COMERCIAL (${num(bd.discountRate * 100, 0)}%)</td><td style="${rowValue} font-weight: bold; color: #CC0000; white-space: nowrap;">-${num(bd.discountAmount, 2)} €</td></tr>
                <tr><td style="${rowLabel} background-color: ${BG_LIGHT}; font-weight: bold; color: ${D_PRIMARY_DARK};">SUBTOTAL ENERGÍA (Neto)</td><td style="${rowValue} background-color: ${BG_LIGHT}; font-weight: bold; color: ${D_PRIMARY_DARK}; white-space: nowrap;">${num(bd.subEnergyWithDiscount, 2)} €</td></tr>
            ` : '';

            const desgloseRows = `
                <!-- TÉRMINO POTENCIA -->
                <tr><td colspan="2"><div style="font-weight: bold; color: ${D_PRIMARY_MED}; padding: 5px 0 2px 0;">TÉRMINO POTENCIA (Precio en €/kW Día)</div></td></tr>
                <tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">P1 (${num(bd.potencia_p1_kw,2)} kW x ${bd.dias_facturados}d x ${numPriceFormula(bd.priceP1Day)})</td><td style="${rowValue} font-family: monospace; font-size: 12px; white-space: nowrap;">${num(bd.costP1, 2)} €</td></tr>
                <tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">P2 (${num(bd.potencia_p2_kw,2)} kW x ${bd.dias_facturados}d x ${numPriceFormula(bd.priceP2Day)})</td><td style="${rowValue} font-family: monospace; font-size: 12px; white-space: nowrap;">${num(bd.costP2, 2)} €</td></tr>
                <tr><td style="${rowLabel} border-bottom: 1px solid #eee; font-weight: bold; color: ${D_PRIMARY_DARK};">SUBTOTAL POTENCIA</td><td style="${rowValue} border-bottom: 1px solid #eee; font-weight: bold; color: ${D_PRIMARY_DARK}; white-space: nowrap;">${num(bd.subPower, 2)} €</td></tr>
                
                <!-- TÉRMINO ENERGÍA -->
                <tr><td colspan="2"><div style="font-weight: bold; color: ${D_PRIMARY_MED}; padding: 5px 0 2px 0;">TÉRMINO ENERGÍA (Precios en €/kWh)</div></td></tr>
                <tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">E1 (${num(bd.consumo_punta,0)} kWh x ${numPriceFormula(offer.p1_price)})</td><td style="${rowValue} font-family: monospace; font-size: 12px; white-space: nowrap;">${num(bd.costE1, 2)} €</td></tr>
                <tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">E2 (${num(bd.consumo_llano,0)} kWh x ${numPriceFormula(offer.p2_price)})</td><td style="${rowValue} font-family: monospace; font-size: 12px; white-space: nowrap;">${num(bd.costE2, 2)} €</td></tr>
                <tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">E3 (${num(bd.consumo_valle,0)} kWh x ${numPriceFormula(offer.p3_price)})</td><td style="${rowValue} font-family: monospace; font-size: 12px; white-space: nowrap;">${num(bd.costE3, 2)} €</td></tr>
                <tr><td style="${rowLabel} border-bottom: 2px solid #333; font-weight: bold; color: #555;">Subtotal Energía (Bruto)</td><td style="${rowValue} border-bottom: 2px solid #333; font-weight: bold; color: #555; white-space: nowrap;">${num(bd.subEnergy, 2)} €</td></tr>
                
                ${discountRowsHtml}
                
                <!-- SUBTOTALES E IMPUESTOS -->
                <tr><td style="${rowLabel} border-top: 2px solid #333; font-weight: bold; color: ${D_PRIMARY_DARK};">SUBTOTAL BASE (P+E)</td><td style="${rowValue} border-top: 2px solid #333; font-weight: bold; color: ${D_PRIMARY_DARK}; white-space: nowrap;">${num(bd.subBase, 2)} €</td></tr>
                <tr><td style="${rowLabel}">Impuesto Eléc. (${num(bd.IE_RATE * 100, 3)}%)</td><td style="${rowValue} white-space: nowrap;">${num(bd.costIE, 2)} €</td></tr>
                <tr><td style="${rowLabel} font-weight: bold;">BASE IMPONIBLE</td><td style="${rowValue} font-weight: bold; white-space: nowrap;">${num(bd.baseImp, 2)} €</td></tr>
                <tr><td style="${rowLabel}">IVA (21%)</td><td style="${rowValue} white-space: nowrap;">${num(bd.costIVA, 2)} €</td></tr>
                
                <!-- TOTALES FINALES (TOTAL MES Y TOTAL AÑO) -->
                <tr><td style="${rowLabel} background-color: #eee; font-weight: bold;">TOTAL MES (PERIODO FACTURADO - ${bd.dias_facturados} DÍAS)</td><td style="${rowValue} background-color: #eee; font-size: 16px; white-space: nowrap;">${eur(bd.totalPeriod)}</td></tr>
                    <!-- LÍNEA DE TOTAL AÑO -->
                <tr><td style="${rowLabel} background-color: #eee; font-weight: bold;">TOTAL AÑO (PROYECTADO)</td><td style="${rowValue} background-color: #eee; font-size: 16px; white-space: nowrap;">${eur(bd.totalAnnual)}</td></tr>
            `;

            // Fila de resumen de descuento para la tabla de precios
            const discountSummaryRow = bd.discountRate > 0 ? `
                <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee; font-weight: bold; color: #CC0000;">DESCUENTO ENERGÍA</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap; color: #CC0000;">${num(bd.discountRate * 100, 0)}%</td></tr>
            ` : '';
            
            const preciosResumenTable = `
                <tr><td colspan="2"><div style="${sectionTitle}">RESUMEN DE PRECIOS DE LA OFERTA ÚNICA</div></td></tr>
                <tr><td colspan="2" style="padding: 0;">
                    <table width="100%" cellpadding="0" cellspacing="0" style="font-family: Arial, sans-serif; font-size: 12px; table-layout: fixed;">
                        <tr style="background-color: #f5f5f5;">
                            <th style="padding: 5px 8px; text-align: left; color: ${D_PRIMARY_DARK}; width: 60%;">CONCEPTO</th>
                            <th style="padding: 5px 8px; text-align: right; color: ${D_PRIMARY_DARK}; width: 40%;">${supplierName}</th>
                        </tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P1 (€/kW/día)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(bd.priceP1Day)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P2 (€/kW/día)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(bd.priceP2Day)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Energía E1 (€/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(offer.p1_price)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Energía E2 (€/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(offer.p2_price)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Energía E3 (€/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; white-space: nowrap;">${numPriceFormula(offer.p3_price)}</td></tr>
                        ${discountSummaryRow}
                        <tr style="background-color: ${BG_LIGHT}; font-weight: bold;"><td style="padding: 8px; color: ${D_PRIMARY_DARK};">AHORRO ANUAL</td><td style="padding: 8px; text-align: right; font-size: 14px; color: ${D_ACCENT_CTA}; white-space: nowrap;">${eur(bd.savings)}</td></tr>
                        <!-- ESPACIO SOLICITADO -->
                        <tr style="background-color: white; height: 10px;"><td colspan="2"></td></tr>
                    </table>
                </td></tr>
            `;

            const finalSavingsSummary = `
                <tr><td colspan="2" style="padding: 0 20px 0 20px; text-align: center;">
                    <div style="text-align: center; margin: 15px 0 5px 0;">
                        <p style="margin: 0; font-size: 16px; color: ${D_PRIMARY_DARK}; font-weight: bold;">RESUMEN DE AHORRO FINAL</p>
                    </div>
                    <div style="background-color: ${BG_LIGHT}; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
                        <p style="margin: 0; font-size: 14px; color: #555;">TU AHORRO ANUAL ESTIMADO ES:</p>
                        <span style="font-size: 32px; font-weight: bold; color: ${D_ACCENT_CTA}; display: block; margin-top: 5px; white-space: nowrap;">${eur(bd.savings)}</span>
                    </div>
                </td></tr>
            `;


            return `
                <table cellpadding="0" cellspacing="0" style="${tableMain}">
                    <!-- HEADER -->
                    <tr><td colspan="2" style="${headerCell}">
                        <h1 style="margin:0; font-size: 24px;">ESTUDIO DE AHORRO</h1>
                        <p style="margin:5px 0 0 0; font-size: 14px; opacity: 0.9;">COMPARATIVA PROFESIONAL - ${D_BRAND_NAME.toUpperCase()}</p>
                    </td></tr>
                    
                    <!-- DATOS CLIENTE -->
                    <tr><td colspan="2" style="padding: 15px;">
                        <p style="margin: 0; font-size: 13px;"><strong>CLIENTE:</strong> ${clientName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>CUPS:</strong> ${bd.cups}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>COMERCIAL:</strong> ${commercialCode || 'N/A'}</p>
                    </td></tr>

                    <!-- TARIFA GANADORA -->
                    <tr><td colspan="2" style="background-color: ${BG_LIGHT}; padding: 15px; text-align: center; border-top: 2px solid ${D_PRIMARY_MED}; border-bottom: 2px solid ${D_PRIMARY_MED};">
                        <p style="margin: 0; color: ${D_PRIMARY_MED}; font-size: 12px; font-weight: bold; letter-spacing: 1px;">LA MEJOR OPCIÓN PARA TI ES</p>
                        <h2 style="margin: 5px 0 0 0; color: ${D_PRIMARY_DARK}; font-size: 22px;">${offer.name}</h2>
                    </td></tr>

                    <!-- 1. AHORRO (RESUMEN POTENTE INICIAL) -->
                    <tr><td colspan="2" style="padding: 0 20px;">
                        <div style="text-align: center; margin: 25px 0 10px 0;">
                            <p style="margin: 0; font-size: 16px; color: #555; font-weight: bold;">TU AHORRO ANUAL ESTIMADO ES:</p>
                        </div>
                        <div style="${savingsBox}">
                            <span style="font-size: 38px; white-space: nowrap;">${eur(bd.savings)}</span>
                            <p style="margin: 5px 0 0 0; font-size: 18px; font-weight: bold;">¡CONSIGUE TU AHORRO ANUAL!</p>
                        </div>
                    </td></tr>

                    <!-- 2. COMPARATIVA (Factura Actual vs. Nuevo Coste) -->
                    <tr><td colspan="2" style="padding: 0 20px;">
                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 20px; table-layout: fixed;">
                            <tr>
                                <td style="width: 50%; padding: 15px; background-color: #f9fafb; border: 1px solid #ddd; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase;">TU FACTURA ACTUAL</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #ef4444; margin: 5px 0; text-decoration: line-through; white-space: nowrap;">${eur(bd.originalBillAnnual)}</div>
                                    <div style="font-size: 11px; color: #666;">/ AÑO</div>
                                </td>
                                <td style="width: 50%; padding: 15px; background-color: ${BG_LIGHT}; border: 1px solid ${D_PRIMARY_MED}; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: ${D_PRIMARY_MED}; text-transform: uppercase;">TU NUEVO COSTE ${D_BRAND_NAME === 'DRK Energía' ? 'DRK' : 'MEJOR OFERTA'}</div>
                                    <div style="font-size: 24px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin: 5px 0; white-space: nowrap;">${eur(bd.totalAnnual)}</div>
                                    <div style="font-size: 11px; color: ${D_PRIMARY_MED};">/ AÑO</div>
                                    <div style="font-size: 13px; font-weight: bold; color: ${D_PRIMARY_DARK}; margin-top: 5px; white-space: nowrap;">${eur(bd.totalAnnual/12)} / MES</div>
                                </td>
                            </tr>
                        </table>
                    </td></tr>
                    
                    <!-- 3. TABLA DE RESUMEN DE PRECIOS -->
                    ${preciosResumenTable}
                    
                    <!-- 4. DESGLOSE DETALLADO -->
                    <tr><td colspan="2"><div style="${sectionTitle}">DESGLOSE DETALLADO DE LA SIMULACIÓN (${offer.name})</div></td></tr>
                    <tr><td colspan="2" style="padding: 0 20px;">
                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-top: 10px; margin-bottom: 20px; table-layout: fixed;">
                            ${desgloseRows}
                        </table>
                    </td></tr>
                    
                    <!-- 5. NUEVO RESUMEN DE AHORRO AL FINAL -->
                    ${finalSavingsSummary}

                    <!-- CTA -->
                    <tr><td colspan="2" style="text-align: center; padding: 0 20px 20px 20px;">
                        <!-- Enlace mailto con cuerpo completo y subject corto -->
                        <a href="${formalizationLink}" style="${btnStyle}">QUIERO LA OFERTA</a>
                        <p style="font-size: 10px; color: #999; margin-top: 10px;">[Colaborador: ${commercialCode}] | Este resumen es una simulación basada en su última factura.</p>
                    </td></tr>

                    <!-- PIE DE PÁGINA BONITO -->
                    <tr><td colspan="2" style="padding: 0; height: 10px;"><div style="${footerStyle}"></div></td></tr>
                </table>
            `;
        }


        function showView(viewId) {
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('results-view').classList.add('hidden');
            document.getElementById('scanner-view').classList.add('hidden');
            document.getElementById('results-view').classList.remove('animate-fade-in-up'); 
            const target = document.getElementById(viewId);
            target.classList.remove('hidden');
            if(viewId === 'results-view') target.classList.add('animate-fade-in-up');
        }
        // Custom Modal de Error/Advertencia
        window.showErrorModal = (msg) => {
            document.getElementById('error-title').textContent = "¡Atención!";
            document.getElementById('error-icon').className = "w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4";
            document.getElementById('error-icon').innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            document.getElementById('error-message').textContent = msg;
            document.getElementById('error-modal').classList.remove('hidden');
            document.getElementById('error-modal').classList.add('flex');
        }
        // Custom Modal de Mensaje Exitoso
        window.showMessageModal = (msg) => {
             document.getElementById('error-title').textContent = "Éxito";
             document.getElementById('error-icon').className = `w-12 h-12 bg-${activeBrand.ACCENT.replace('500', '100')} text-${activeBrand.ACCENT} rounded-full flex items-center justify-center mx-auto mb-4`;
             document.getElementById('error-icon').innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
             document.getElementById('error-message').textContent = msg;
             document.getElementById('error-modal').classList.remove('hidden');
             document.getElementById('error-modal').classList.add('flex');
        }
        window.hideErrorModal = () => {
            document.getElementById('error-modal').classList.add('hidden');
            document.getElementById('error-modal').classList.remove('flex');
        }
        
        // Reset App y forzar el branding DRK de vuelta
        window.resetApp = () => {
            stopScanner();
            lastComparisonResult = null;
            // Aseguramos que la UI base siempre vuelva a DRK
            applyBrandStyles(BRANDS.DRK); 
            // Re-aplicar los estilos de los selectores para que se muestren correctamente
            updateComparisonMode(comparisonMode);
            showView('initial-view');
            els.loadingStatus.classList.add('hidden');
            els.startScanBtn.disabled = false;
            els.uploadMenuBtn.disabled = false; 
        };
        
        // --- LÓGICA DE ESCÁNER Y CÁMARA ---
        function startScanner() {
            if (currentTariffs.length === 0) return window.showErrorModal("Cargando tarifas, espere...");
            if (scannerRunning) return;
            showView('scanner-view');
            scannerRunning = true;
            video = document.createElement('video');
            video.autoplay = true;
            video.playsInline = true;
            canvas = document.createElement('canvas');
            canvasCtx = canvas.getContext('2d');
            els.interactiveViewport.innerHTML = '';
            els.interactiveViewport.appendChild(video);
            
            // Usar la cámara trasera por defecto
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
                stream = s; video.srcObject = stream;
                video.onloadedmetadata = () => { video.play(); scanLoop(); };
            }).catch(err => {
                console.error(err); stopScanner();
                window.showErrorModal("Error al acceder a la cámara. Asegúrese de dar permisos. Si está en escritorio, use la opción de 'Subir Imagen'.");
                window.resetApp();
            });
        }
        function scanLoop() {
            if (!scannerRunning || !video || video.readyState !== video.HAVE_ENOUGH_DATA) { animationFrameId = requestAnimationFrame(scanLoop); return; }
            if (canvas.width !== video.videoWidth) { canvas.width = video.videoWidth; canvas.height = video.videoHeight; }
            canvasCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvasCtx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) { handleQRRead(code.data); } else { animationFrameId = requestAnimationFrame(scanLoop); }
        }
        function stopScanner() {
            scannerRunning = false;
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            if (stream) stream.getTracks().forEach(t => t.stop());
            video = null;
            stream = null;
        }
        function capturePhoto() {
            if (!video || video.readyState !== video.HAVE_ENOUGH_DATA) return;
            // Detenemos el loop temporalmente para el procesamiento manual
            stopScanner();
            els.loadingStatus.textContent = "Procesando foto...";
            els.loadingStatus.classList.remove('hidden');
            
            canvas.width = video.videoWidth; 
            canvas.height = video.videoHeight;
            canvasCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvasCtx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            els.loadingStatus.classList.add('hidden');
            if (code) handleQRRead(code.data); 
            else { 
                window.showErrorModal("No se detectó ningún QR. Asegúrese de que el código esté bien enfocado."); 
                startScanner(); // Reiniciar el escáner si falla la captura
            }
        }

        // --- LÓGICA DE SUBIDA/PEGADO DE IMAGEN ---
        function setupPasteCatcher() {
            document.addEventListener('paste', (e) => {
                // Solo reaccionar al pegar si el modal de opciones está abierto Y el pasteCatcher está enfocado (simulando un input activo)
                if (document.getElementById('qr-options-modal').classList.contains('hidden') || !document.getElementById('paste-catcher').matches(':focus')) return; 
                
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const blob = items[i].getAsFile();
                        if (blob) {
                            document.getElementById('qr-options-modal').classList.add('hidden');
                            e.preventDefault();
                            processImageForQR(blob);
                            break;
                        }
                    }
                }
            });
            document.getElementById('modal-paste-image-btn').addEventListener('click', () => {
                document.getElementById('paste-catcher').focus();
                window.showMessageModal("Presione CTRL+V (Windows) o CMD+V (Mac) para pegar la imagen.");
                // Ocultar el mensaje después de 3 segundos
                setTimeout(window.hideErrorModal, 3000); 
            });
        }
        function processImageForQR(file) {
            if (currentTariffs.length === 0) return window.showErrorModal("Cargando tarifas, espere...");

            els.loadingStatus.textContent = "Procesando imagen...";
            els.loadingStatus.classList.remove('hidden');
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    let { width, height } = img;
                    // Redimensionar para rendimiento
                    const max_dim = 1500;
                    if (width > max_dim || height > max_dim) {
                        const ratio = Math.min(max_dim / width, max_dim / height);
                        width *= ratio; height *= ratio;
                    }
                    tempCanvas.width = width; tempCanvas.height = height;
                    tempCtx.drawImage(img, 0, 0, width, height);
                    try {
                        const imageData = tempCtx.getImageData(0, 0, width, height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);
                        els.loadingStatus.classList.add('hidden');
                        if (code) handleQRRead(code.data);
                        else window.showErrorModal("No se encontró QR en la imagen. Asegúrese de que el código esté visible y claro.");
                    } catch (error) {
                        console.error(error); els.loadingStatus.classList.add('hidden');
                        window.showErrorModal("Error procesando la imagen.");
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Función para manejar cambios de modo y actualizar estilos
        function updateComparisonMode(newMode) {
            comparisonMode = newMode;
            
            // LÓGICA: Aplicar branding inmediatamente al cambiar el modo
            let currentBrandForInput = BRANDS.DRK;
            if (newMode === 'overall_best') {
                currentBrandForInput = BRANDS.POWER_CUP;
            }
            applyBrandStyles(currentBrandForInput); 
            
            // 1. Aplicar estilos del botón de QR (Abrir en el Móvil)
            const qrToggleLabel = els.qrToggleCheckbox.closest('label');
            const toggleSpan = qrToggleLabel.querySelector('span');
            const activePrefix = currentBrandForInput.NAME === 'DRK Energía' ? 'drk' : 'powercup'; // Usamos el prefijo para la limpieza

            // Limpiar clases de marca anterior
            qrToggleLabel.classList.forEach(cls => {
                if (cls.startsWith('text-drk') || cls.startsWith('text-powercup') || cls.startsWith('hover:text-drk') || cls.startsWith('hover:text-powercup')) {
                    qrToggleLabel.classList.remove(cls);
                }
            });
            toggleSpan.classList.forEach(cls => {
                if (cls.startsWith('decoration-drk') || cls.startsWith('decoration-powercup')) {
                    toggleSpan.classList.remove(cls);
                }
            });
            
            // Aplicar clases de la marca activa (Text color y underline decoration)
            qrToggleLabel.classList.add(currentBrandForInput.PRIMARY_TEXT, `hover:text-${activePrefix}-900`);
            toggleSpan.classList.add(`decoration-${activePrefix}-500`);
            
            
            // ** CRÍTICO: Actualizar el QR al cambiar de modo **
            if (els.qrToggleCheckbox.checked) {
                 generateInstallQR(newMode);
            }

            // Obtener el prefijo de color de la marca ACTIVA (ya configurada por applyBrandStyles)
            // Ya que el branding solo cambia si es overall_best y es ganadora, forzamos el color del hover aquí.
            const drkPrefix = 'drk';
            const powerCupPrefix = 'powercup';

            document.querySelectorAll('input[name="comparison_mode"]').forEach(radio => {
                const label = radio.closest('label');
                const checkmark = label.querySelector('.checkmark-icon'); // Buscar el nuevo icono
                const spanText = label.querySelector('span'); // Span que contiene el texto del selector
                
                // 2. Limpieza de todos los estilos dinámicos de borde y hover
                label.classList.remove('border-drk-500', 'bg-drk-500', 'hover:bg-drk-600', 'border-drk-300', 'hover:bg-drk-100');
                label.classList.remove('border-powercup-500', 'bg-powercup-500', 'hover:bg-powercup-600', 'border-powercup-300', 'hover:bg-powercup-100');
                
                // Limpieza de texto de fondo para evitar conflictos
                label.classList.remove('text-white', 'text-slate-600', 'bg-white');

                const mode = radio.value;
                const isDrkMode = mode === 'drk_only' || mode === 'drk_prioritized';
                const prefix = isDrkMode ? drkPrefix : powerCupPrefix;

                if (mode === newMode) {
                    // 3. Estilo Seleccionado (Fondo de color fuerte, texto blanco)
                    label.classList.add(`border-${prefix}-500`, `bg-${prefix}-500`, 'text-white', `hover:bg-${prefix}-600`);
                    
                    // MOSTRAR ICONO SELECCIONADO
                    if (checkmark) {
                        checkmark.style.visibility = 'visible';
                        checkmark.classList.add('text-white'); 
                    }
                } else {
                    // 4. Estilo No Seleccionado
                    
                    // Hover deseado: Azul suave (drk-100) para DRK, Verde suave (powercup-100) para Mejor Mercado
                    const hoverClass = `hover:bg-${prefix}-100`;

                    // Si el selector no activo corresponde a la marca ACTIVA global,
                    // el texto DEBE ser el color primario de esa marca, no gris (text-slate-600).
                    const textColor = (mode === 'overall_best' && newMode !== 'overall_best') ? 'text-powercup-800' : 
                                             (mode !== 'overall_best' && newMode !== 'overall_best') ? 'text-drk-800' : 'text-slate-600';

                    label.classList.add(`border-${prefix}-300`, 'bg-white', textColor, hoverClass);
                    
                    // OCULTAR ICONO NO SELECCIONADO
                    if (checkmark) {
                        checkmark.style.visibility = 'hidden';
                        checkmark.classList.remove('text-white');
                        checkmark.classList.add('text-slate-600');
                    }
                }
            });
        }
        
        // --- FUNCIÓN PARA GENERAR EL QR DE INSTALACIÓN ---
        function generateInstallQR(mode = comparisonMode) {
            const url = EXTERNAL_APP_URL; 
            const size = 160; 
            
            // Colores por defecto (DRK)
            let QR_DARK_COLOR = "#0c4a6e"; // DRK 900
            let QR_LIGHT_COLOR = "#ffffff";
            let QR_BORDER_COLOR = "#0ea5e9"; // DRK 500
            let QR_CENTER_BG = "#0c4a6e";
            let QR_CENTER_TEXT = 'DRK';

            // Si el modo es "Mejor en el Mercado", usamos el diseño de Power Cup (Verde/Oscuro)
            if (mode === 'overall_best') {
                // Estilos Power Cup (Verde)
                QR_DARK_COLOR = "#3f6212"; // PowerCup 800 (Oscuro) para los módulos
                QR_BORDER_COLOR = "#84cc16"; // PowerCup 500 (Verde principal) para el borde
                QR_CENTER_BG = "#3f6212"; // PowerCup 800 (Fondo central)
                QR_CENTER_TEXT = 'CUP'; // Texto central: CUP
            }

            // Aplicar estilos dinámicos al contenedor visual
            els.qrVisualContainer.style.setProperty('--qr-border-color', QR_BORDER_COLOR);
            els.qrVisualContainer.style.setProperty('--qr-center-bg', QR_CENTER_BG);
            els.qrVisualContainer.style.setProperty('--qr-center-text', `'${QR_CENTER_TEXT}'`);


            // Limpiar el contenedor del QR antes de generar
            els.qrCodeContainer.innerHTML = '';

            if (typeof QRCode === 'undefined') {
                els.qrCodeContainer.innerHTML = '<p class="text-xs text-red-500">Error: QR library not loaded.</p>';
                return;
            }

            // Generar el código QR
            new QRCode(els.qrCodeContainer, {
                text: url,
                width: size,
                height: size,
                colorDark : QR_DARK_COLOR,
                colorLight : QR_LIGHT_COLOR,
                correctLevel : QRCode.CorrectLevel.H
            });
            
            // Ajustar estilos del canvas generado
            const canvasElement = els.qrCodeContainer.querySelector('canvas');
            if (canvasElement) {
                canvasElement.style.margin = '0 auto';
                canvasElement.style.display = 'block';
                canvasElement.style.padding = '10px'; 
                canvasElement.style.backgroundColor = QR_LIGHT_COLOR; 
            }
        }
        
        // --- LÓGICA DE TOGGLE DEL QR ---
        function toggleQRSection() {
            if (els.qrToggleCheckbox.checked) {
                // Si el QR está marcado para mostrar, regenerar con el modo actual
                generateInstallQR(comparisonMode);
                els.qrContentWrapper.classList.add('active');
            } else {
                els.qrContentWrapper.classList.remove('active');
            }
        }


        // --- FUNCIÓN DE INICIALIZACIÓN ---
        function initApp() {
            // 1. Intentar cargar la última versión de Google Sheets
            fetchTariffsFromSheet();

            // 2. Establecer el branding inicial (DRK por defecto)
            // Esto llamará a applyBrandStyles y cargará el logo DRK por defecto.
            applyBrandStyles(BRANDS.DRK);
            
            // 3. Generar el código QR de instalación (usa el modo por defecto)
            generateInstallQR(comparisonMode);

            // 4. Listeners
            els.startScanBtn.addEventListener('click', startScanner);
            els.stopScanBtn.addEventListener('click', resetApp); // Cancelar escáner debe resetear la app
            els.capturePhotoBtn.addEventListener('click', capturePhoto);
            
            // Listener para el toggle del QR
            els.qrToggleCheckbox.addEventListener('change', toggleQRSection);
            
            // Listener para mostrar el modal de OFERTA (Copiar HTML)
            els.sendOfferBtn.addEventListener('click', () => {
                if (lastComparisonResult) {
                    els.sendOfferModal.classList.remove('hidden');
                    els.sendOfferModal.classList.add('flex');
                    // Resetear el estilo de los modales por si ha cambiado el tema.
                    document.getElementById('modal-client-data-title').classList.remove('text-drk-800', 'text-powercup-800');
                    document.getElementById('modal-client-data-title').classList.add(activeBrand.PRIMARY_TEXT);
                    document.getElementById('comercial-code-input').classList.remove('focus:ring-drk-500', 'focus:ring-powercup-500');
                    document.getElementById('comercial-code-input').classList.add(`focus:ring-${activeBrand.ACCENT}`);
                    // aplicar estilo a todos los inputs
                    document.querySelectorAll('#send-offer-modal input').forEach(input => {
                        input.classList.remove('focus:ring-drk-500', 'focus:ring-powercup-500');
                        input.classList.add(`focus:ring-${activeBrand.ACCENT}`);
                    });
                } else {
                    window.showErrorModal("Por favor, analice una factura primero para generar una oferta.");
                }
            });
            
            // Listener unificado para COPIAR COMPARATIVO (HTML)
            els.executeSendOfferBtn.addEventListener('click', handleCopyOffer);


            // Listeners para el menú de opciones QR manual
            els.uploadMenuBtn.addEventListener('click', () => {
                els.qrOptionsModal.classList.remove('hidden');
                // aplicar estilos de marca a los botones del modal QR
                document.getElementById('modal-upload-file-btn').classList.remove('bg-drk-800', 'hover:bg-drk-900', 'bg-powercup-800', 'hover:bg-powercup-900');
                document.getElementById('modal-upload-file-btn').classList.add(`bg-${activeBrand.ACCENT.replace('500', '800')}`, `hover:bg-${activeBrand.ACCENT.replace('500', '900')}`);
                document.getElementById('modal-paste-image-btn').classList.remove('bg-drk-600', 'hover:bg-drk-800', 'bg-powercup-600', 'hover:bg-powercup-800');
                document.getElementById('modal-paste-image-btn').classList.add(`bg-${activeBrand.ACCENT.replace('500', '600')}`, `hover:bg-${activeBrand.ACCENT.replace('500', '800')}`);
            });
            document.getElementById('modal-upload-file-btn').addEventListener('click', () => document.getElementById('image-file-input').click()); 
            
            document.getElementById('image-file-input').addEventListener('change', (e) => {
                els.qrOptionsModal.classList.add('hidden');
                if (e.target.files[0]) processImageForQR(e.target.files[0]);
                // Limpiar input después de usar
                e.target.value = ''; 
            });
            
            // Configurar el "pegado" de imagen
            setupPasteCatcher();
            
            // 5. Listeners for Comparison Mode
            document.querySelectorAll('input[name="comparison_mode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    updateComparisonMode(e.target.value);
                });
                // Set initial state on load
                if (radio.checked) {
                    updateComparisonMode(radio.value);
                }
            });
            
            console.log("App iniciada. Cargando tarifas automáticamente...");
        }

        window.onload = initApp;

    </script>
</body>
</html>
